name: Load Testing

on:
  push:
    branches: [main]
    paths:
      - 'src/ai_vs_human/api.py'
      - 'tests/loadtests/**'
      - '.github/workflows/load_test.yaml'
  pull_request:
    branches: [main]
    paths:
      - 'src/ai_vs_human/api.py'
      - 'tests/loadtests/**'
  workflow_dispatch:  # Allow manual triggering
    inputs:
      num_users:
        description: 'Number of concurrent users'
        required: false
        default: '20'
      run_time:
        description: 'Test duration (e.g., 1m, 30s)'
        required: false
        default: '1m'

jobs:
  load-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv sync

      - name: Create necessary directories
        run: mkdir -p reports

      - name: Start API in background
        run: |
          uv run uvicorn ai_vs_human.api:app --host 0.0.0.0 --port 8000 &
          echo "Waiting for API to start..."
          sleep 15
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          WANDB_ENTITY: ${{ secrets.WANDB_ENTITY }}
          WANDB_PROJECT: ${{ secrets.WANDB_PROJECT }}

      - name: Check API health
        run: |
          curl -f http://localhost:8000/health || exit 1
          echo "API is healthy and ready for load testing"

      - name: Run pytest-based load tests
        run: uv run pytest tests/loadtests/test_load.py -v -s
        continue-on-error: true  # Don't fail workflow if load tests have issues

      - name: Run Locust headless load test
        run: |
          USERS=${{ github.event.inputs.num_users || '20' }}
          RUN_TIME=${{ github.event.inputs.run_time || '1m' }}
          uv run locust -f tests/loadtests/locustfile.py \
            --host=http://localhost:8000 \
            --users $USERS \
            --spawn-rate 5 \
            --run-time $RUN_TIME \
            --headless \
            --html reports/load_test_report.html \
            --csv reports/load_test_results
        continue-on-error: true

      - name: Upload load test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-reports
          path: |
            reports/load_test_report.html
            reports/load_test_results*.csv
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Check if CSV file exists
            const csvFiles = fs.readdirSync('reports').filter(f => f.startsWith('load_test_results') && f.endsWith('_stats.csv'));
            
            if (csvFiles.length === 0) {
              console.log('No CSV results file found');
              return;
            }
            
            const csvContent = fs.readFileSync(`reports/${csvFiles[0]}`, 'utf8');
            const lines = csvContent.split('\n').filter(l => l.trim());
            
            let comment = '## Load Test Results\n\n';
            comment += '| Endpoint | # Requests | Failures | Avg (ms) | Min (ms) | Max (ms) | RPS |\n';
            comment += '|----------|------------|----------|----------|----------|----------|---------|\n';
            
            // Parse CSV (skip header and aggregated row)
            for (let i = 1; i < lines.length - 1; i++) {
              const parts = lines[i].split(',');
              if (parts.length >= 7) {
                comment += `| ${parts[1]} | ${parts[2]} | ${parts[3]} | ${parts[4]} | ${parts[5]} | ${parts[6]} | ${parts[7]} |\n`;
              }
            }
            
            comment += '\n [Download full HTML report](../actions/runs/${{ github.run_id }})\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Stop API
        if: always()
        run: pkill -f uvicorn || true
